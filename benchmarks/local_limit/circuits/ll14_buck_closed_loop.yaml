schema: pulsim-v1
version: 1
benchmark:
  id: ll14_buck_closed_loop
  category: local_limit
  validation:
    type: none
simulation:
  tstart: 0.0
  tstop: 5e-3
  dt: 0.5e-6
components:
  - type: voltage_source
    name: Vin
    nodes: [vin, 0]
    waveform:
      type: dc
      value: 24.0

  - type: voltage_source
    name: Vref
    nodes: [vref, 0]
    waveform:
      type: dc
      value: 12.0

  # Power Stage
  - type: vcswitch
    name: S_buck
    nodes: [pwm_gate, vin, sw]
    v_threshold: 1.0
    ron: 0.05
    roff: 1e7

  - type: diode
    name: D_buck
    nodes: [0, sw]
    is: 1e-12
    n: 1.2
    
  - type: inductor
    name: L1
    nodes: [sw, vout]
    value: 100u

  - type: capacitor
    name: Cout
    nodes: [vout, 0]
    value: 220u

  - type: resistor
    name: Rload
    nodes: [vout, 0]
    value: 10.0

  # Control Loop
  - type: math_block
    name: ErrorCalc
    nodes: [vref, vout]
    operation: sub

  - type: pi_controller
    name: PI1
    nodes: [ErrorCalc, vref, pi_out_dummy_node] # [err, ref, out]
    kp: 0.02
    ki: 40.0
    output_min: 0.1
    output_max: 0.9
    anti_windup: 1.0

  - type: pwm_generator
    name: PWM1
    nodes: [PI1]
    frequency: 100000.0
    duty_min: 0.05
    duty_max: 0.95
    v_high: 5.0
    v_low: 0.0

  # Route PWM to gate via a stiff resistor to help nodes
  - type: resistor
    name: Rgate
    nodes: [PWM1, pwm_gate]
    value: 1.0
  - type: resistor
    name: Rgate_gnd
    nodes: [pwm_gate, 0]
    value: 10k
