name: Publish to PyPI

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      publish_to_pypi:
        description: 'Publish to PyPI (otherwise just build)'
        required: false
        default: false
        type: boolean

jobs:
  # =============================================================================
  # Build Wheels for All Platforms
  # =============================================================================
  build-wheels:
    name: Build wheels - ${{ matrix.os }} (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64
          - os: ubuntu-latest
            arch: x86_64
            cibw_archs: x86_64

          # Windows x64
          - os: windows-latest
            arch: AMD64
            cibw_archs: AMD64

          # macOS Intel
          - os: macos-13
            arch: x86_64
            cibw_archs: x86_64

          # macOS Apple Silicon
          - os: macos-14
            arch: arm64
            cibw_archs: arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Update version from tag
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            VERSION_TAG="${GITHUB_REF_NAME#v}"
            echo "Setting version to $VERSION_TAG"
            # More robust regex that handles various formats
            sed -i.bak -E 's/^version[[:space:]]*=[[:space:]]*"[^"]*"/version = "'"$VERSION_TAG"'"/' pyproject.toml || \
            python -c "
          import re
          with open('pyproject.toml', 'r') as f:
              content = f.read()
          content = re.sub(r'^version\s*=\s*[\"'][^\"']*[\"']', 'version = \"$VERSION_TAG\"', content, count=1, flags=re.M)
          with open('pyproject.toml', 'w') as f:
              f.write(content)
          "
            rm -f pyproject.toml.bak
            echo "Updated version:"
            grep "^version" pyproject.toml
          else
            echo "Not a tag push, keeping existing version"
          fi

      - name: Install cibuildwheel
        run: pip install cibuildwheel==2.22.0

      - name: Build wheels
        run: python -m cibuildwheel --output-dir wheelhouse
        env:
          CIBW_BUILD: cp310-* cp311-* cp312-* cp313-*
          CIBW_SKIP: "*-musllinux_* *-win32 *-manylinux_i686"
          CIBW_ARCHS: ${{ matrix.cibw_archs }}

          # macOS deployment target
          CIBW_ENVIRONMENT_MACOS: >-
            MACOSX_DEPLOYMENT_TARGET=11.0

          # Linux: Install build tools
          CIBW_BEFORE_ALL_LINUX: |
            if command -v yum &> /dev/null; then
              yum install -y cmake3 ninja-build || yum install -y cmake ninja-build
              ln -sf /usr/bin/cmake3 /usr/local/bin/cmake || true
            elif command -v apt-get &> /dev/null; then
              apt-get update && apt-get install -y cmake ninja-build
            fi

          # Windows: Install build tools via pip
          CIBW_BEFORE_BUILD_WINDOWS: |
            python -m pip install --upgrade pip setuptools wheel
            python -m pip install cmake ninja scikit-build-core pybind11

          # Linux: Install Python build deps
          CIBW_BEFORE_BUILD_LINUX: |
            python -m pip install --upgrade pip setuptools wheel
            python -m pip install cmake ninja scikit-build-core pybind11

          # macOS: Install build tools via Homebrew
          CIBW_BEFORE_BUILD_MACOS: |
            brew install cmake ninja || true
            python -m pip install --upgrade pip setuptools wheel
            python -m pip install scikit-build-core pybind11

          CIBW_BUILD_VERBOSITY: 1

          # Test configuration
          CIBW_TEST_REQUIRES: pytest numpy scipy
          CIBW_TEST_COMMAND: pytest {project}/python/tests -v --ignore={project}/python/tests/validation
          CIBW_TEST_COMMAND_WINDOWS: pytest {project}\python\tests -v --ignore={project}\python\tests\validation

      - name: List built wheels
        shell: bash
        run: ls -la wheelhouse/

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}-${{ matrix.arch }}
          path: ./wheelhouse/*.whl

  # =============================================================================
  # Build Source Distribution
  # =============================================================================
  build-sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Update version from tag
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            VERSION_TAG="${GITHUB_REF_NAME#v}"
            echo "Setting version to $VERSION_TAG"
            sed -i -E 's/^version[[:space:]]*=[[:space:]]*"[^"]*"/version = "'"$VERSION_TAG"'"/' pyproject.toml
            echo "Updated version:"
            grep "^version" pyproject.toml
          else
            echo "Not a tag push, keeping existing version"
          fi

      - name: Install build
        run: pip install build

      - name: Build sdist
        run: python -m build --sdist

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz

  # =============================================================================
  # Publish to PyPI
  # =============================================================================
  publish:
    name: Publish to PyPI
    needs: [build-wheels, build-sdist]
    runs-on: ubuntu-latest
    # Only publish on tag push or manual trigger with publish_to_pypi=true
    if: >
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) ||
      (github.event_name == 'workflow_dispatch' && inputs.publish_to_pypi)
    permissions:
      id-token: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Display structure of downloaded files
        run: |
          echo "=== Downloaded artifacts ==="
          ls -la dist/
          echo "=== Wheel files ==="
          ls -la dist/*.whl || echo "No wheel files found"
          echo "=== Source distribution ==="
          ls -la dist/*.tar.gz || echo "No sdist found"

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/

  # =============================================================================
  # Create GitHub Release
  # =============================================================================
  create-release:
    name: Create GitHub Release
    needs: [publish]
    runs-on: ubuntu-latest
    # Only create release on tag push
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
